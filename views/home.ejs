<%- include("plantillas/header") %>

<div class="row">
  <!-- Sección Departamentos -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-primary text-white">
        Agregar Departamento
      </div>
      <div class="card-body">
        <form method="POST" action="/departments/add" class="row g-2">
          <div class="col-md-4">
            <input type="text" name="code" placeholder="Código" class="form-control" required>
          </div>
          <div class="col-md-6">
            <input type="text" name="name" placeholder="Nombre" class="form-control" required>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-success">Agregar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Sección Municipios -->
  <div class="col-md-6">
    <div class="card mb-4 shadow">
      <div class="card-header bg-success text-white">
        Agregar Municipio
      </div>
      <div class="card-body">
        <form method="POST" action="/towns/add" class="row g-2">
          <div class="col-md-3">
            <input type="text" name="code" placeholder="Código" class="form-control" required>
          </div>
          <div class="col-md-4">
            <select name="department" id="department" class="form-select" required>
              <option value="">Departamento...</option>
              <% departments.forEach(dep => { %>
                <option value="<%= dep.code %>"><%= dep.name %></option>
              <% }) %>
            </select>
          </div>
          <div class="col-md-3">
            <input type="text" name="name" placeholder="Municipio" class="form-control" required>
          </div>
          <div class="col-md-2 d-grid">
            <button class="btn btn-success">Agregar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>


<div class="card shadow mb-4">
  <div class="card-header bg-secondary text-white">
    Departamentos y Municipios
  </div>
  <div class="card-body row g-2">
    <div class="col-md-6">
      <select id="depSelect" class="form-select">
        <option value="">Seleccione departamento...</option>
        <% departments.forEach(dep => { %>
          <option value="<%= dep.code %>"><%= dep.name %></option>
        <% }) %>
      </select>
    </div>
    <div class="col-md-6">
      <select id="townSelect" class="form-select">
        <option value="">Seleccione municipio...</option>
      </select>
    </div>
  </div>
</div>

<!-- Listado -->
<div class="card shadow">
  <div class="card-header bg-dark text-white">
    Listado de Municipios
  </div>
  <div class="card-body">
    <table class="table table-striped align-middle">
      <thead>
        <tr>
          <th>Código</th>
          <th>Departamento</th>
          <th>Nombre</th>
          <th class="text-center">Acciones</th>
        </tr>
      </thead>
      <tbody>
        <% towns.forEach(t => { %>
          <tr>
            <td><%= t.code %></td>
            <td><%= t.department %></td>
            <td><%= t.name %></td>
            <td class="text-center">
              <div class="d-flex justify-content-center gap-2">
                <!-- Botón Editar -->
                <button class="btn btn-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal<%= t.code %>">Editar</button>

                <!-- Eliminar -->
                <form method="POST" action="/towns/delete/<%= t.code %>">
                  <button class="btn btn-danger btn-sm">Eliminar</button>
                </form>
              </div>
            </td>
          </tr>

          <!-- Editar -->
          <div class="modal fade" id="editModal<%= t.code %>" tabindex="-1">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="POST" action="/towns/edit/<%= t.code %>">
                  <div class="modal-header">
                    <h5 class="modal-title">Editar Municipio</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <input type="text" name="name" value="<%= t.name %>" class="form-control" required>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button class="btn btn-primary">Guardar cambios</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
document.getElementById("depSelect").addEventListener("change", async function() {
  const dep = this.value;
  const townSelect = document.getElementById("townSelect");
  townSelect.innerHTML = "<option value=''>Cargando...</option>";

  if(dep) {
    const res = await fetch(`/towns/by-department/${dep}`);
    const towns = await res.json();

    townSelect.innerHTML = "<option value=''>Seleccione municipio...</option>";
    towns.forEach(t => {
      townSelect.innerHTML += `<option value="${t.code}">${t.name}</option>`;
    });
  } else {
    townSelect.innerHTML = "<option value=''>Seleccione municipio...</option>";
  }
});
</script>

<%- include("plantillas/footer") %>
